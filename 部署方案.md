# 八字命理AI人生指导系统部署方案

## 1. 部署架构概述

八字命理AI人生指导系统采用前后端分离的架构，部署方案包括前端H5页面部署和后端服务部署两部分。系统将主要以公众号H5页面的形式提供服务，同时预留了小程序封装的可能性。

### 1.1 部署架构图

```
+------------------+    +-------------------+    +-------------------+
|                  |    |                   |    |                   |
|   用户 (微信)    +--->+   公众号H5页面    +--->+   前端静态资源    |
|                  |    |                   |    |   (CDN托管)       |
+------------------+    +-------------------+    +-------------------+
                                                          |
                                                          v
+------------------+    +-------------------+    +-------------------+
|                  |    |                   |    |                   |
|   对象存储服务   |<---+   数据库服务      |<---+   后端API服务    |
|  (PDF文档存储)   |    | (MongoDB云数据库) |    |   (云服务器)     |
|                  |    |                   |    |                   |
+------------------+    +-------------------+    +-------------------+
```

## 2. 环境要求

### 2.1 前端部署环境
- Node.js 14.0+
- npm 6.0+
- 静态资源托管服务（如阿里云OSS、腾讯云COS等）
- CDN加速服务

### 2.2 后端部署环境
- Ubuntu 20.04 LTS或CentOS 8.0+
- Node.js 14.0+
- npm 6.0+
- MongoDB 4.4+
- Nginx 1.18+
- PM2 5.0+

### 2.3 第三方服务
- 微信公众平台账号
- 微信支付商户号
- 支付宝开放平台账号
- OpenAI API密钥
- 短信服务提供商账号

## 3. 前端部署步骤

### 3.1 构建前端资源

1. 安装依赖并构建生产环境资源
```bash
cd /path/to/bazi_project/frontend
npm install
npm run build
```

2. 构建完成后，生成的静态资源将位于`/path/to/bazi_project/frontend/dist`目录

### 3.2 部署到静态资源托管服务

#### 3.2.1 阿里云OSS部署
1. 登录阿里云控制台，创建OSS存储桶
2. 配置存储桶为静态网站托管模式
3. 上传dist目录下的所有文件到存储桶根目录
4. 配置自定义域名和HTTPS证书
5. 配置CDN加速

#### 3.2.2 腾讯云COS部署
1. 登录腾讯云控制台，创建COS存储桶
2. 配置存储桶为静态网站托管模式
3. 上传dist目录下的所有文件到存储桶根目录
4. 配置自定义域名和HTTPS证书
5. 配置CDN加速

### 3.3 配置微信公众号

1. 登录微信公众平台
2. 配置JS接口安全域名为前端部署域名
3. 配置网页授权域名为前端部署域名
4. 在公众号菜单中添加链接到前端页面的菜单项

## 4. 后端部署步骤

### 4.1 服务器环境配置

1. 更新系统并安装基础软件
```bash
sudo apt update && sudo apt upgrade -y
sudo apt install -y git curl build-essential
```

2. 安装Node.js
```bash
curl -fsSL https://deb.nodesource.com/setup_14.x | sudo -E bash -
sudo apt install -y nodejs
```

3. 安装PM2
```bash
sudo npm install -g pm2
```

4. 安装Nginx
```bash
sudo apt install -y nginx
```

5. 配置防火墙
```bash
sudo ufw allow 22
sudo ufw allow 80
sudo ufw allow 443
sudo ufw enable
```

### 4.2 MongoDB数据库配置

#### 4.2.1 使用MongoDB Atlas云数据库
1. 注册并登录MongoDB Atlas
2. 创建新集群
3. 配置数据库用户和网络访问权限
4. 获取连接字符串

#### 4.2.2 自建MongoDB服务器
1. 安装MongoDB
```bash
wget -qO - https://www.mongodb.org/static/pgp/server-4.4.asc | sudo apt-key add -
echo "deb [ arch=amd64,arm64 ] https://repo.mongodb.org/apt/ubuntu focal/mongodb-org/4.4 multiverse" | sudo tee /etc/apt/sources.list.d/mongodb-org-4.4.list
sudo apt update
sudo apt install -y mongodb-org
```

2. 启动MongoDB服务
```bash
sudo systemctl start mongod
sudo systemctl enable mongod
```

3. 创建数据库和用户
```bash
mongo
> use bazi_system
> db.createUser({user: "baziuser", pwd: "your_password", roles: [{role: "readWrite", db: "bazi_system"}]})
> exit
```

### 4.3 部署后端代码

1. 克隆代码到服务器
```bash
git clone https://your-repository-url.git /var/www/bazi_backend
cd /var/www/bazi_backend
```

2. 安装依赖
```bash
npm install
```

3. 创建环境变量配置文件
```bash
cp .env.example .env
nano .env
```

4. 配置环境变量
```
PORT=3000
MONGODB_URI=mongodb+srv://username:password@cluster.mongodb.net/bazi_system
JWT_SECRET=your_jwt_secret_key
NODE_ENV=production
OPENAI_API_KEY=your_openai_api_key
WECHAT_APP_ID=your_wechat_app_id
WECHAT_MCH_ID=your_wechat_mch_id
WECHAT_API_KEY=your_wechat_api_key
ALIPAY_APP_ID=your_alipay_app_id
ALIPAY_PRIVATE_KEY=your_alipay_private_key
ALIPAY_PUBLIC_KEY=your_alipay_public_key
```

5. 使用PM2启动应用
```bash
pm2 start src/app.js --name bazi-api
pm2 save
pm2 startup
```

### 4.4 配置Nginx反向代理

1. 创建Nginx配置文件
```bash
sudo nano /etc/nginx/sites-available/bazi-api
```

2. 添加以下配置
```nginx
server {
    listen 80;
    server_name api.yourdomain.com;

    location / {
        proxy_pass http://localhost:3000;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection 'upgrade';
        proxy_set_header Host $host;
        proxy_cache_bypass $http_upgrade;
    }
}
```

3. 启用站点配置
```bash
sudo ln -s /etc/nginx/sites-available/bazi-api /etc/nginx/sites-enabled/
sudo nginx -t
sudo systemctl restart nginx
```

### 4.5 配置HTTPS

1. 安装Certbot
```bash
sudo apt install -y certbot python3-certbot-nginx
```

2. 获取SSL证书
```bash
sudo certbot --nginx -d api.yourdomain.com
```

3. 配置自动续期
```bash
sudo systemctl status certbot.timer
```

## 5. 微信公众号H5页面集成

### 5.1 微信公众号配置

1. 登录微信公众平台
2. 配置JS接口安全域名
   - 添加前端部署域名
   - 添加后端API域名
3. 配置网页授权域名
   - 添加前端部署域名
4. 配置业务域名
   - 添加前端部署域名
   - 添加后端API域名

### 5.2 微信支付配置

1. 登录微信商户平台
2. 配置支付授权目录
   - 添加前端支付页面URL路径
3. 配置支付回调URL
   - 设置为后端支付回调API地址

### 5.3 公众号菜单配置

1. 登录微信公众平台
2. 进入自定义菜单配置
3. 添加菜单项，链接到前端H5页面
   - 菜单名称：八字命理AI
   - 链接类型：跳转网页
   - 网页地址：https://yourdomain.com/

## 6. 小程序封装（可选）

### 6.1 微信小程序封装

1. 注册微信小程序账号
2. 创建小程序项目
3. 使用WebView组件加载H5页面
4. 配置小程序域名白名单
5. 提交审核并发布

### 6.2 抖音小程序封装

1. 注册抖音小程序账号
2. 创建小程序项目
3. 使用WebView组件加载H5页面
4. 配置小程序域名白名单
5. 提交审核并发布

## 7. 系统维护

### 7.1 日常维护

1. 监控系统运行状态
```bash
pm2 monit
```

2. 查看系统日志
```bash
pm2 logs bazi-api
```

3. 更新系统
```bash
cd /var/www/bazi_backend
git pull
npm install
pm2 restart bazi-api
```

### 7.2 数据备份

1. 设置MongoDB定时备份
```bash
mongodump --uri="mongodb+srv://username:password@cluster.mongodb.net/bazi_system" --out=/backup/mongodb/$(date +"%Y-%m-%d")
```

2. 创建备份脚本
```bash
#!/bin/bash
BACKUP_DIR="/backup/mongodb"
DATE=$(date +"%Y-%m-%d")
mongodump --uri="mongodb+srv://username:password@cluster.mongodb.net/bazi_system" --out=$BACKUP_DIR/$DATE
find $BACKUP_DIR -type d -mtime +7 -exec rm -rf {} \;
```

3. 设置定时任务
```bash
crontab -e
# 添加以下行
0 2 * * * /path/to/backup_script.sh
```

## 8. 故障排除

### 8.1 前端问题排查

1. 检查网络请求
   - 使用浏览器开发者工具查看网络请求
   - 检查API请求是否正常
   - 检查响应状态码和内容

2. 检查控制台错误
   - 使用浏览器开发者工具查看控制台错误
   - 解决JavaScript错误

### 8.2 后端问题排查

1. 检查API服务状态
```bash
pm2 status
```

2. 检查日志
```bash
pm2 logs bazi-api
```

3. 检查数据库连接
```bash
mongo mongodb+srv://username:password@cluster.mongodb.net/bazi_system
```

4. 检查Nginx配置
```bash
sudo nginx -t
```

### 8.3 常见问题解决

1. API服务无法启动
   - 检查环境变量配置
   - 检查MongoDB连接字符串
   - 检查端口占用情况

2. 支付回调失败
   - 检查支付回调URL配置
   - 检查支付参数
   - 检查服务器防火墙设置

3. AI分析生成失败
   - 检查OpenAI API密钥
   - 检查网络连接
   - 检查请求参数格式

## 9. 扩展与升级

### 9.1 系统扩展

1. 增加更多分析维度
   - 修改前端表单
   - 更新AI提示词模板
   - 扩展分析结果展示

2. 添加会员订阅功能
   - 设计会员等级和权益
   - 实现订阅支付功能
   - 添加会员专属功能

### 9.2 性能优化

1. 前端优化
   - 代码分割和懒加载
   - 图片优化
   - 缓存策略

2. 后端优化
   - 数据库索引优化
   - API缓存
   - 负载均衡

## 10. 总结

本部署方案详细描述了八字命理AI人生指导系统的部署步骤和配置要求，包括前端H5页面部署、后端API服务部署、数据库配置、微信公众号集成等内容。按照本方案进行部署，可以将系统成功部署到公众号H5页面或封装成小程序，为用户提供便捷的八字命理AI分析服务。

# 八字命理AI人生指导系统架构设计

## 1. 系统架构概述

八字命理AI人生指导系统采用前后端分离的架构设计，主要由前端应用、后端服务、数据库、第三方服务集成四大部分组成。系统设计遵循模块化、可扩展、安全可靠的原则，确保系统能够稳定运行并支持未来功能扩展。

### 1.1 整体架构图

```
+------------------+    +-------------------+    +-------------------+
|                  |    |                   |    |                   |
|   用户 (浏览器)   +--->+   前端应用(H5)    +--->+   后端服务(API)   |
|                  |    |                   |    |                   |
+------------------+    +-------------------+    +--------+----------+
                                                          |
                                                          v
+------------------+    +-------------------+    +-------------------+
|                  |    |                   |    |                   |
|   对象存储服务    |<---+   数据库服务      |<---+   第三方服务集成   |
|  (PDF文档存储)    |    | (用户/订单/结果)  |    | (支付/AI/短信)    |
|                  |    |                   |    |                   |
+------------------+    +-------------------+    +-------------------+
```

### 1.2 技术选型

#### 前端技术栈
- 框架：Vue.js 3.0 (使用Composition API)
- UI组件库：Vant UI (移动端优先)
- 状态管理：Pinia
- 路由：Vue Router
- HTTP客户端：Axios
- 构建工具：Vite
- PDF生成：jsPDF + html2canvas

#### 后端技术栈
- 开发语言：Node.js
- Web框架：Express.js
- 数据库：MongoDB
- ORM/ODM：Mongoose
- 缓存：Redis
- 身份认证：JWT
- API文档：Swagger

#### 部署环境
- 前端部署：静态资源CDN
- 后端部署：云服务器
- 数据库部署：云数据库服务
- 对象存储：云对象存储服务

## 2. 系统组件设计

### 2.1 前端组件

#### 2.1.1 页面组件
- **主页组件**：展示系统介绍和用户信息输入表单
- **支付组件**：处理订单支付流程
- **结果展示组件**：展示八字分析结果和提供PDF下载
- **用户中心组件**：管理用户信息和历史记录
- **登录注册组件**：处理用户认证

#### 2.1.2 公共组件
- **导航组件**：页面导航和菜单
- **表单组件**：统一的表单输入控件
- **加载组件**：数据加载状态展示
- **弹窗组件**：消息提示和确认框
- **日期选择组件**：支持公历和农历切换的日期选择器

#### 2.1.3 状态管理
- **用户状态**：管理用户登录信息和权限
- **订单状态**：管理订单创建和支付流程
- **分析结果状态**：管理八字分析结果数据

### 2.2 后端组件

#### 2.2.1 API服务层
- **用户API**：处理用户注册、登录和信息管理
- **订单API**：处理订单创建和支付流程
- **八字分析API**：处理八字计算和AI分析请求
- **PDF生成API**：处理PDF文档生成和存储

#### 2.2.2 业务逻辑层
- **用户服务**：用户数据处理和权限验证
- **订单服务**：订单流程管理和支付处理
- **八字计算服务**：实现八字命理计算逻辑
- **AI分析服务**：处理与ChatGPT的交互
- **PDF生成服务**：生成和管理PDF文档

#### 2.2.3 数据访问层
- **用户数据访问**：用户数据的CRUD操作
- **订单数据访问**：订单数据的CRUD操作
- **八字结果数据访问**：分析结果数据的CRUD操作

#### 2.2.4 基础设施层
- **数据库连接管理**：管理MongoDB连接
- **缓存管理**：管理Redis缓存
- **日志服务**：系统日志记录和管理
- **配置管理**：系统配置参数管理
- **错误处理**：统一的错误处理机制

### 2.3 数据库设计

#### 2.3.1 MongoDB集合设计

**用户集合(users)**
```json
{
  "_id": "ObjectId",
  "phone": "String",
  "passwordHash": "String",
  "createTime": "Date",
  "lastLoginTime": "Date",
  "status": "String"
}
```

**订单集合(orders)**
```json
{
  "_id": "ObjectId",
  "userId": "ObjectId",
  "amount": "Number",
  "status": "String",
  "paymentMethod": "String",
  "createTime": "Date",
  "payTime": "Date",
  "resultId": "ObjectId"
}
```

**八字结果集合(baziResults)**
```json
{
  "_id": "ObjectId",
  "userId": "ObjectId",
  "orderId": "ObjectId",
  "gender": "String",
  "birthTime": {
    "year": "Number",
    "month": "Number",
    "day": "Number",
    "hour": "Number",
    "isLunar": "Boolean"
  },
  "focusAreas": ["String"],
  "baziData": {
    "yearPillar": {
      "heavenlyStem": "String",
      "earthlyBranch": "String",
      "element": "String"
    },
    "monthPillar": {
      "heavenlyStem": "String",
      "earthlyBranch": "String",
      "element": "String"
    },
    "dayPillar": {
      "heavenlyStem": "String",
      "earthlyBranch": "String",
      "element": "String"
    },
    "hourPillar": {
      "heavenlyStem": "String",
      "earthlyBranch": "String",
      "element": "String"
    },
    "fiveElements": {
      "wood": "Number",
      "fire": "Number",
      "earth": "Number",
      "metal": "Number",
      "water": "Number"
    },
    "flowingYears": [
      {
        "year": "Number",
        "heavenlyStem": "String",
        "earthlyBranch": "String",
        "element": "String"
      }
    ]
  },
  "aiAnalysis": {
    "health": "String",
    "wealth": "String",
    "career": "String",
    "relationship": "String",
    "children": "String",
    "overall": "String"
  },
  "pdfUrl": "String",
  "createTime": "Date"
}
```

### 2.4 第三方服务集成

#### 2.4.1 支付服务集成
- **微信支付**：集成微信支付API，处理支付请求和回调
- **支付宝**：集成支付宝API，处理支付请求和回调

#### 2.4.2 AI服务集成
- **ChatGPT API**：集成OpenAI的ChatGPT API，处理八字分析请求

#### 2.4.3 短信服务集成
- **短信验证码**：集成短信服务提供商API，处理验证码发送和验证

#### 2.4.4 对象存储服务集成
- **PDF存储**：集成对象存储服务，存储生成的PDF文档

## 3. 数据流程设计

### 3.1 用户注册登录流程

```
+-------------+    +-------------+    +-------------+    +-------------+
|             |    |             |    |             |    |             |
| 用户输入手机号 +--->+ 发送验证码  +--->+ 验证码校验  +--->+ 创建/登录用户 |
|             |    |             |    |             |    |             |
+-------------+    +-------------+    +-------------+    +-------------+
                                                                |
                                                                v
                                                        +-------------+
                                                        |             |
                                                        | 返回JWT令牌  |
                                                        |             |
                                                        +-------------+
```

### 3.2 八字分析流程

```
+-------------+    +-------------+    +-------------+    +-------------+
|             |    |             |    |             |    |             |
| 用户提交信息  +--->+ 创建订单    +--->+ 用户支付    +--->+ 支付成功回调 |
|             |    |             |    |             |    |             |
+-------------+    +-------------+    +-------------+    +-------------+
                                                                |
                                                                v
+-------------+    +-------------+    +-------------+    +-------------+
|             |    |             |    |             |    |             |
| 返回分析结果  |<---+ 处理AI响应  |<---+ 调用AI接口  |<---+ 计算八字数据 |
|             |    |             |    |             |    |             |
+-------------+    +-------------+    +-------------+    +-------------+
        |
        v
+-------------+    +-------------+
|             |    |             |
| 生成PDF文档  +--->+ 存储结果    |
|             |    |             |
+-------------+    +-------------+
```

### 3.3 历史记录查询流程

```
+-------------+    +-------------+    +-------------+
|             |    |             |    |             |
| 用户登录     +--->+ 请求历史记录 +--->+ 查询数据库  |
|             |    |             |    |             |
+-------------+    +-------------+    +-------------+
                                              |
                                              v
                                      +-------------+
                                      |             |
                                      | 返回历史数据 |
                                      |             |
                                      +-------------+
```

## 4. API接口设计

### 4.1 用户API

#### 4.1.1 发送验证码
- **URL**: `/api/user/sendVerifyCode`
- **方法**: POST
- **请求体**:
  ```json
  {
    "phone": "string"
  }
  ```
- **响应**:
  ```json
  {
    "code": 200,
    "message": "验证码已发送",
    "data": null
  }
  ```

#### 4.1.2 用户登录/注册
- **URL**: `/api/user/login`
- **方法**: POST
- **请求体**:
  ```json
  {
    "phone": "string",
    "verifyCode": "string"
  }
  ```
- **响应**:
  ```json
  {
    "code": 200,
    "message": "登录成功",
    "data": {
      "token": "string",
      "userId": "string"
    }
  }
  ```

#### 4.1.3 获取用户信息
- **URL**: `/api/user/info`
- **方法**: GET
- **请求头**: Authorization: Bearer {token}
- **响应**:
  ```json
  {
    "code": 200,
    "message": "成功",
    "data": {
      "userId": "string",
      "phone": "string",
      "createTime": "string"
    }
  }
  ```

### 4.2 订单API

#### 4.2.1 创建订单
- **URL**: `/api/order/create`
- **方法**: POST
- **请求头**: Authorization: Bearer {token}
- **请求体**:
  ```json
  {
    "gender": "string",
    "birthTime": {
      "year": "number",
      "month": "number",
      "day": "number",
      "hour": "number",
      "isLunar": "boolean"
    },
    "focusAreas": ["string"]
  }
  ```
- **响应**:
  ```json
  {
    "code": 200,
    "message": "订单创建成功",
    "data": {
      "orderId": "string",
      "amount": "number"
    }
  }
  ```

#### 4.2.2 获取支付信息
- **URL**: `/api/order/payment`
- **方法**: POST
- **请求头**: Authorization: Bearer {token}
- **请求体**:
  ```json
  {
    "orderId": "string",
    "paymentMethod": "string" // "wechat" 或 "alipay"
  }
  ```
- **响应**:
  ```json
  {
    "code": 200,
    "message": "成功",
    "data": {
      "paymentUrl": "string", // 支付二维码URL或支付链接
      "orderId": "string"
    }
  }
  ```

#### 4.2.3 查询订单状态
- **URL**: `/api/order/status/{orderId}`
- **方法**: GET
- **请求头**: Authorization: Bearer {token}
- **响应**:
  ```json
  {
    "code": 200,
    "message": "成功",
    "data": {
      "orderId": "string",
      "status": "string", // "pending", "paid", "failed"
      "resultId": "string" // 如果已支付，返回结果ID
    }
  }
  ```

### 4.3 八字分析API

#### 4.3.1 获取分析结果
- **URL**: `/api/bazi/result/{resultId}`
- **方法**: GET
- **请求头**: Authorization: Bearer {token}
- **响应**:
  ```json
  {
    "code": 200,
    "message": "成功",
    "data": {
      "resultId": "string",
      "baziData": {
        // 八字数据
      },
      "aiAnalysis": {
        // AI分析结果
      },
      "pdfUrl": "string"
    }
  }
  ```

#### 4.3.2 获取历史分析记录
- **URL**: `/api/bazi/history`
- **方法**: GET
- **请求头**: Authorization: Bearer {token}
- **响应**:
  ```json
  {
    "code": 200,
    "message": "成功",
    "data": [
      {
        "resultId": "string",
        "createTime": "string",
        "focusAreas": ["string"],
        "pdfUrl": "string"
      }
    ]
  }
  ```

#### 4.3.3 下载PDF文档
- **URL**: `/api/bazi/pdf/{resultId}`
- **方法**: GET
- **请求头**: Authorization: Bearer {token}
- **响应**: PDF文件流

## 5. 八字计算模块设计

### 5.1 模块结构

```
+------------------+    +-------------------+    +-------------------+
|                  |    |                   |    |                   |
|   日期转换模块    +--->+   八字计算模块    +--->+   命盘生成模块    |
| (公历/农历转换)   |    | (天干地支计算)    |    | (八字命盘数据)    |
|                  |    |                   |    |                   |
+------------------+    +-------------------+    +-------------------+
                                                          |
                                                          v
                                                +-------------------+
                                                |                   |
                                                |   流年大运模块    |
                                                | (大运流年计算)    |
                                                |                   |
                                                +-------------------+
```

### 5.2 关键算法

#### 5.2.1 公历转农历算法
利用开源万年历数据，实现公历日期到农历日期的准确转换。

#### 5.2.2 真太阳时计算
根据出生地经度和时区，计算真太阳时，提高八字计算的准确性。

#### 5.2.3 八字计算
根据出生年月日时，计算四柱八字（年柱、月柱、日柱、时柱）。

#### 5.2.4 五行属性分析
分析八字中五行（金、木、水、火、土）的分布情况和强弱。

#### 5.2.5 大运流年计算
根据八字和性别，计算大运和流年信息。

## 6. AI分析模块设计

### 6.1 模块结构

```
+------------------+    +-------------------+    +-------------------+
|                  |    |                   |    |                   |
|   提示词模板     +--->+   ChatGPT API    +--->+   响应处理模块    |
| (根据侧重点)     |    | (发送分析请求)    |    | (格式化结果)     |
|                  |    |                   |    |                   |
+------------------+    +-------------------+    +-------------------+
```

### 6.2 提示词设计

为确保AI分析的专业性和准确性，设计专业的提示词模板，包括：

1. **基础信息部分**：提供用户的八字信息和基本背景
2. **分析要求部分**：根据用户选择的侧重点，指导AI进行针对性分析
3. **输出格式部分**：规定AI返回结果的格式，便于后续处理

### 6.3 响应处理

1. **分段处理**：将AI返回的长文本分割为不同主题的段落
2. **关键信息提取**：提取每个主题中的关键建议和预测
3. **格式优化**：调整文本格式，使其适合网页展示和PDF生成

## 7. 支付模块设计

### 7.1 模块结构

```
+------------------+    +-------------------+
|                  |    |                   |
|   微信支付集成   |    |   支付宝集成      |
|                  |    |                   |
+------------------+    +-------------------+
          |                      |
          v                      v
+------------------+    +-------------------+
|                  |    |                   |
|   支付状态管理   |<---+   回调处理模块    |
|                  |    |                   |
+------------------+    +-------------------+
          |
          v
+------------------+
|                  |
|   订单状态更新   |
|                  |
+------------------+
```

### 7.2 支付流程

1. **创建订单**：用户提交信息后，系统创建订单记录
2. **生成支付参数**：根据用户选择的支付方式，生成相应的支付参数
3. **发起支付请求**：前端调用支付接口，用户完成支付
4. **接收支付通知**：后端接收支付平台的异步通知
5. **验证支付结果**：验证支付通知的真实性和有效性
6. **更新订单状态**：根据支付结果更新订单状态
7. **触发后续流程**：支付成功后，触发八字计算和AI分析流程

## 8. PDF生成模块设计

### 8.1 模块结构

```
+------------------+    +-------------------+    +-------------------+
|                  |    |                   |    |                   |
|   模板管理模块   +--->+   内容渲染模块    +--->+   PDF生成模块    |
|                  |    |                   |    |                   |
+------------------+    +-------------------+    +-------------------+
                                                          |
                                                          v
                                                +-------------------+
                                                |                   |
                                                |   存储管理模块    |
                                                |                   |
                                                +-------------------+
```

### 8.2 PDF生成流程

1. **准备模板**：根据分析内容选择合适的PDF模板
2. **填充内容**：将用户信息、八字数据和AI分析结果填充到模板中
3. **生成PDF**：使用PDF生成库将渲染后的内容转换为PDF文档
4. **存储PDF**：将生成的PDF上传到对象存储服务
5. **更新记录**：将PDF的URL更新到八字结果记录中

## 9. 安全设计

### 9.1 身份认证与授权

1. **JWT认证**：使用JWT进行用户身份认证
2. **权限控制**：基于角色的访问控制
3. **Token过期机制**：设置合理的Token有效期，并支持刷新

### 9.2 数据安全

1. **HTTPS传输**：所有API请求使用HTTPS加密传输
2. **敏感数据加密**：用户密码等敏感信息使用bcrypt等算法加密存储
3. **参数验证**：所有API请求参数进行严格验证，防止注入攻击

### 9.3 支付安全

1. **签名验证**：对支付请求和回调进行签名验证
2. **订单幂等性**：确保支付操作的幂等性，防止重复支付
3. **日志记录**：详细记录支付相关操作日志，便于问题排查

## 10. 部署架构

### 10.1 开发环境

- 本地开发环境
- 测试服务器环境

### 10.2 生产环境

```
+------------------+    +-------------------+    +-------------------+
|                  |    |                   |    |                   |
|   CDN (前端)     +--->+   负载均衡器      +--->+   应用服务器     |
|                  |    |                   |    |                   |
+------------------+    +-------------------+    +-------------------+
                                                          |
                                                          v
+------------------+    +-------------------+    +-------------------+
|                  |    |                   |    |                   |
|   对象存储服务   |<---+   数据库服务      |<---+   缓存服务       |
|                  |    |                   |    |                   |
+------------------+    +-------------------+    +-------------------+
```

### 10.3 公众号H5部署

1. **前端资源部署**：将前端资源部署到CDN
2. **公众号配置**：在微信公众平台配置网页授权域名
3. **微信授权集成**：实现微信授权登录功能
4. **公众号菜单配置**：配置公众号菜单，指向H5应用

## 11. 扩展性设计

### 11.1 功能扩展

1. **多语言支持**：预留多语言支持接口
2. **更多分析维度**：支持添加更多的分析侧重点
3. **会员订阅**：支持会员订阅模式，提供更多高级功能

### 11.2 性能扩展

1. **水平扩展**：应用服务器支持水平扩展
2. **数据库分片**：支持数据库分片，提高数据处理能力
3. **缓存优化**：优化缓存策略，提高响应速度

## 12. 监控与运维

### 12.1 监控系统

1. **应用监控**：监控应用服务的运行状态
2. **性能监控**：监控系统性能指标
3. **错误监控**：监控系统错误和异常

### 12.2 日志系统

1. **集中式日志**：实现日志的集中收集和存储
2. **日志分析**：支持日志查询和分析
3. **告警机制**：设置关键指标的告警阈值

### 12.3 备份与恢复

1. **数据库备份**：定期备份数据库
2. **配置备份**：备份系统配置
3. **恢复机制**：制定数据恢复流程和策略

## 13. 开发与部署流程

### 13.1 开发流程

1. **需求分析**：明确功能需求和技术要求
2. **架构设计**：设计系统架构和组件
3. **编码实现**：按照设计进行编码
4. **测试验证**：进行单元测试和集成测试
5. **部署上线**：部署到生产环境

### 13.2 部署流程

1. **环境准备**：准备服务器和相关服务
2. **代码部署**：部署前端和后端代码
3. **配置设置**：配置系统参数和第三方服务
4. **数据迁移**：迁移必要的初始数据
5. **服务启动**：启动应用服务
6. **验证测试**：验证系统功能和性能

## 14. 总结

本架构设计文档详细描述了八字命理AI人生指导系统的架构设计，包括系统组件、数据流程、API接口、模块设计、安全设计、部署架构等内容。系统采用前后端分离的架构，使用现代化的技术栈，确保系统的可靠性、安全性和可扩展性。

在实际开发过程中，可能会根据具体情况对架构进行适当调整和优化，以满足项目的实际需求和技术条件。
